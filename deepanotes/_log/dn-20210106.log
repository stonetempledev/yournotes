2021-01-06 15:31:46,432 [9] INFO dn_lib.tools.log - reload core
2021-01-06 15:31:46,489 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:31:46,492 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,506 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,517 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,527 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,537 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,548 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,557 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,564 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,574 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,576 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,576 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,577 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,578 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,578 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,579 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,580 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,580 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,586 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,588 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,589 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,590 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,591 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,592 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,592 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,594 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:31:46,713 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:31:46,714 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,714 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,715 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,716 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,717 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,718 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,718 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,719 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,720 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,720 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,721 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,721 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,722 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,723 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,723 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,724 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,724 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,725 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,725 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,726 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,726 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,727 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,728 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,728 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,729 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:31:46,807 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:31:46,808 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,809 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,811 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,812 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,813 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,814 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,817 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,818 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,819 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,820 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,821 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,822 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,823 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,823 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,824 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,824 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,825 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:46,825 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:46,826 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:46,826 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:46,827 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:46,827 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:46,828 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:46,828 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:46,844 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:31:54,224 [9] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 15:31:54,239 [9] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:31:54,248 [9] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 15:31:54,264 [9] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 15:31:54,282 [9] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 15:31:54,321 [9] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 15:31:54,341 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 15:31:54,442 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 15:31:54,445 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 15:31:54,449 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 15:31:58,893 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:31:58,894 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:58,895 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:58,896 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:58,897 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:58,898 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:58,899 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:58,900 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:58,901 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:58,902 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:58,903 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:58,903 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:58,904 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:58,904 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:58,905 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:58,905 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:58,906 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:58,906 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:31:58,907 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:31:58,907 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:31:58,908 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:31:58,908 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:31:58,909 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:31:58,909 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:31:58,910 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:31:58,911 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:31:58,960 [9] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 48
2021-01-06 15:31:58,962 [9] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 48
2021-01-06 15:32:05,919 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:32:05,920 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,921 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,922 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,922 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,923 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,923 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,923 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,924 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,924 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,925 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,925 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,925 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,926 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,926 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,927 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,927 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,928 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,928 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,929 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,930 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,931 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,931 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,932 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,932 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,933 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:32:05,956 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:32:05,957 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,958 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,959 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,959 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,960 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,960 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,961 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,962 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,962 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,963 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,964 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,964 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,965 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,966 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,966 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,967 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,968 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:05,968 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:05,969 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:05,970 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:05,970 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:05,971 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:05,971 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:05,972 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:05,972 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:32:06,010 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:32:06,011 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:06,011 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:06,012 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:06,013 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:06,013 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:06,014 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:06,014 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:06,015 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:06,015 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:06,016 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:06,016 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:06,017 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:06,018 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:06,018 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:06,018 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:06,019 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:06,019 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:32:06,020 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:32:06,020 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:32:06,021 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:32:06,021 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:32:06,021 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:32:06,022 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:32:06,022 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:32:06,023 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:32:15,346 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desiderio';
declare @sid varchar(100); set @sid = 'za0bu1botpil0au4hucola0m';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select count(*) from dn_search_tasks where search_id = @id;


2021-01-06 15:32:44,634 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 15:32:45,092 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:32:46,064 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 15:32:46,074 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 15:32:46,081 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 15:32:55,850 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 15:32:55,858 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 15:32:55,860 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 15:32:55,862 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 15:32:55,864 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 15:33:43,910 [17] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:33:43,911 [17] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,913 [17] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,914 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,914 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,915 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,915 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,916 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,916 [17] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,916 [17] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,917 [17] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,917 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,917 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,918 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,918 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,919 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,919 [17] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,919 [17] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,920 [17] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,920 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,921 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,921 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,921 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,922 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,922 [17] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,923 [17] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:33:43,932 [17] DEBUG dn_lib.tools.log - SQL: if not exists (select top 1 1 from users_cache where [user_id] = 0 and var_name = 'active-task-filter')
        insert into users_cache ([user_id], var_name, var_value)
          values (0, 'active-task-filter', '2')
        else update users_cache set var_value = substring('2', 1, 500), dt_upd = getdate()
          where [user_id] = 0 and var_name = 'active-task-filter'
2021-01-06 15:33:43,946 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:33:43,948 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,949 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,950 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,951 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,953 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,954 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,954 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,955 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,956 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,957 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,957 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,958 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,959 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,959 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,960 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,961 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,962 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:33:43,963 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:33:43,964 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:33:43,965 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:33:43,966 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:33:43,968 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:33:43,969 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:33:43,970 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:33:43,971 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:33:48,773 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desiderio';
declare @sid varchar(100); set @sid = 'za0bu1botpil0au4hucola0m';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select count(*) from dn_search_tasks where search_id = @id;


2021-01-06 15:33:51,396 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 15:33:51,399 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:33:51,403 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:33:51,404 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 15:33:51,416 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 15:33:51,423 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 0
2021-01-06 15:33:51,444 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 15:33:51,447 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 15:33:51,450 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 15:33:51,452 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 15:33:51,455 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 15:34:04,806 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:34:04,808 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,809 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,810 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,811 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,812 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,812 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,813 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,814 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,815 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,815 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,816 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,817 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,818 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,818 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,819 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,820 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,821 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,822 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,823 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,823 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,824 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,825 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,826 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,827 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,827 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:34:04,851 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:34:04,852 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,852 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,853 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,853 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,854 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,854 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,855 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,855 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,856 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,856 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,857 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,857 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,858 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,858 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,859 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,859 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,860 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,860 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,861 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,861 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,861 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,862 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,862 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,863 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,863 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:34:04,900 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:34:04,901 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,902 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,902 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,903 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,903 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,904 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,904 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,904 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,905 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,905 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,906 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,906 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,906 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,907 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,907 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,907 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,908 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:04,908 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:04,909 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:04,909 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:04,910 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:04,910 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:04,911 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:04,911 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:04,912 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:34:10,561 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'pillo';
declare @sid varchar(100); set @sid = 'za0bu1botpil0au4hucola0m';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select count(*) from dn_search_tasks where search_id = @id;


2021-01-06 15:34:13,603 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 15:34:13,604 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:34:13,605 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:34:13,607 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 15:34:13,609 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 15:34:13,611 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 0
2021-01-06 15:34:13,613 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 15:34:13,616 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 15:34:13,619 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 15:34:13,619 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 15:34:13,620 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 15:34:21,464 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:34:21,467 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,467 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,468 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,469 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,470 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,470 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,470 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,471 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,471 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,472 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,473 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,474 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,475 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,475 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,476 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,476 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,477 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,477 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,478 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,478 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,478 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,479 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,479 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,479 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,480 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:34:21,491 [25] DEBUG dn_lib.tools.log - SQL: if not exists (select top 1 1 from users_cache where [user_id] = 0 and var_name = 'active-task-filter')
        insert into users_cache ([user_id], var_name, var_value)
          values (0, 'active-task-filter', '6')
        else update users_cache set var_value = substring('6', 1, 500), dt_upd = getdate()
          where [user_id] = 0 and var_name = 'active-task-filter'
2021-01-06 15:34:21,511 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 15:34:21,512 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,513 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,514 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,515 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,516 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,516 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,517 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,517 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,518 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,518 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,519 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,519 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,519 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,520 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,520 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,520 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,521 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 15:34:21,521 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 15:34:21,522 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 15:34:21,522 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 15:34:21,522 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 15:34:21,523 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 15:34:21,524 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 15:34:21,525 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 15:34:21,525 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 15:34:22,713 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'pillo';
declare @sid varchar(100); set @sid = 'za0bu1botpil0au4hucola0m';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select count(*) from dn_search_tasks where search_id = @id;


2021-01-06 15:34:22,738 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 15:34:22,741 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 15:34:22,743 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 15:34:22,772 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 15:34:22,802 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 15:34:22,855 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 15:34:22,861 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 15:34:22,864 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 15:34:22,867 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 15:34:22,869 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:02:33,746 [7] INFO dn_lib.tools.log - reload core
2021-01-06 16:02:33,782 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:02:33,784 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,785 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,786 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,788 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,790 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,800 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,802 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,804 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,805 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,806 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,807 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,807 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,809 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,809 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,810 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,810 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,810 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,817 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,819 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,821 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,821 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,823 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,823 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,824 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,826 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:02:33,911 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:02:33,912 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,912 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,913 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,914 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,915 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,916 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,917 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,917 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,918 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,918 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,919 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,919 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,919 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,919 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,920 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,920 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,921 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,921 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,922 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,922 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,923 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:33,923 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:33,924 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:33,924 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:33,925 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:02:33,995 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:02:33,996 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:33,997 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:33,998 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:33,999 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:33,999 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:34,000 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:34,001 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:34,002 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:34,002 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:34,003 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:34,004 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:34,004 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:34,005 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:34,005 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:34,006 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:34,006 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:34,007 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:02:34,007 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:02:34,008 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:02:34,008 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:02:34,009 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:02:34,010 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:02:34,010 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:02:34,011 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:02:34,024 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:02:50,110 [9] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:02:50,117 [9] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:02:50,143 [9] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in System.Boolean.Parse(String value)
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 221
2021-01-06 16:02:50,174 [9] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 312
   in dn_lib.core.parse_query(String key, String[,] flds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 130
   in deepanotes.notes.load_folders(Nullable`1 folder_id, Nullable`1 synch_folder_id, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 134
   in deepanotes.notes.load_objects(Nullable`1 folder_id, Nullable`1 synch_folder_id, task_filter tf, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 44
   in _notes.OnInit(EventArgs e) in c:\root\todd\git\dn\deepanotes\notes.aspx.cs:riga 269
2021-01-06 16:04:13,524 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:04:13,525 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:04:13,526 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:04:13,527 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:04:13,527 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:04:13,528 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:04:13,529 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:04:13,529 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:04:13,530 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:04:13,531 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:04:13,532 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:04:13,533 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:04:13,533 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:04:13,534 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:04:13,534 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:04:13,535 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:04:13,535 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:04:13,536 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:04:13,536 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:04:13,537 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:04:13,537 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:04:13,538 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:04:13,538 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:04:13,539 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:04:13,540 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:04:13,540 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:04:21,699 [7] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:04:22,137 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:04:49,919 [7] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in System.Boolean.Parse(String value)
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 221
2021-01-06 16:04:56,133 [7] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 312
   in dn_lib.core.parse_query(String key, String[,] flds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 130
   in deepanotes.notes.load_folders(Nullable`1 folder_id, Nullable`1 synch_folder_id, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 134
   in deepanotes.notes.load_objects(Nullable`1 folder_id, Nullable`1 synch_folder_id, task_filter tf, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 44
   in _notes.OnInit(EventArgs e) in c:\root\todd\git\dn\deepanotes\notes.aspx.cs:riga 269
2021-01-06 16:05:21,624 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:05:21,625 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:05:21,626 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:05:21,627 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:05:21,628 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:05:21,629 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:05:21,630 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:05:21,631 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:05:21,632 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:05:21,632 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:05:21,633 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:05:21,634 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:05:21,635 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:05:21,635 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:05:21,636 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:05:21,636 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:05:21,637 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:05:21,637 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:05:21,638 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:05:21,639 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:05:21,640 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:05:21,641 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:05:21,642 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:05:21,643 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:05:21,643 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:05:21,643 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:05:23,086 [7] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:05:23,089 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:06:07,901 [7] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in System.Boolean.Parse(String value)
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 221
2021-01-06 16:06:07,922 [7] ERROR dn_lib.tools.log - error
System.FormatException: Stringa non riconosciuta come valore Boolean valido.
   in dn_lib.core.parse(String text, Dictionary`2 flds, DataRow dr, Dictionary`2 conds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 312
   in dn_lib.core.parse_query(String key, String[,] flds) in C:\root\todd\git\dn\dn_lib\core.cs:riga 130
   in deepanotes.notes.load_folders(Nullable`1 folder_id, Nullable`1 synch_folder_id, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 134
   in deepanotes.notes.load_objects(Nullable`1 folder_id, Nullable`1 synch_folder_id, task_filter tf, Nullable`1 search_id) in c:\root\todd\git\dn\deepanotes\App_Code\notes.cs:riga 44
   in _notes.OnInit(EventArgs e) in c:\root\todd\git\dn\deepanotes\notes.aspx.cs:riga 269
2021-01-06 16:07:35,672 [8] INFO dn_lib.tools.log - reload core
2021-01-06 16:07:35,716 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:07:35,718 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,719 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,720 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,724 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,732 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,741 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,744 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,746 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,747 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,749 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,749 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,750 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,752 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,753 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,754 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,755 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,755 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,770 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,772 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,773 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,774 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,775 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,776 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,777 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,778 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:07:35,830 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:07:35,832 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,833 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,834 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,835 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,836 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,837 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,838 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,839 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,840 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,841 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,841 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,842 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,843 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,843 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,844 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,845 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,845 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,846 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,847 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,848 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,849 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,850 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,851 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,852 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,853 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:07:35,922 [20] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:07:35,923 [20] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,924 [20] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,924 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,925 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,926 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,927 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,927 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,928 [20] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,929 [20] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,929 [20] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,930 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,930 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,931 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,932 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,933 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,934 [20] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,935 [20] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:35,935 [20] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:35,935 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:35,936 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:35,937 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:35,937 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:35,938 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:35,939 [20] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:35,944 [20] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:07:38,728 [20] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:07:39,134 [20] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:07:39,845 [20] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:07:39,869 [20] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:07:39,879 [20] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:07:40,955 [20] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:07:40,980 [20] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:07:41,073 [20] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:07:41,075 [20] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:07:41,077 [20] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:07:46,310 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:07:46,311 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:46,312 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:46,312 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:46,314 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:46,315 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:46,315 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:46,316 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:46,317 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:46,317 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:46,318 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:46,319 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:46,319 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:46,320 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:46,320 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:46,321 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:46,321 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:46,322 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:46,323 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:46,323 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:46,324 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:46,325 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:46,325 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:46,326 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:46,326 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:46,327 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:07:46,373 [8] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 47
2021-01-06 16:07:46,373 [8] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 47
2021-01-06 16:07:56,037 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:07:56,038 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:56,039 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:56,040 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:56,041 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:56,042 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:56,043 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:56,044 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:56,045 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:56,045 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:56,046 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:56,047 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:56,048 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:56,049 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:56,049 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:56,050 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:56,051 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:56,051 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:07:56,052 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:07:56,052 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:07:56,053 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:07:56,054 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:07:56,054 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:07:56,055 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:07:56,056 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:07:56,056 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:07:56,069 [8] DEBUG dn_lib.tools.log - SQL: select t.synch_folder_id, t.task_id, t.title, f.folder_id as parent_folder_id, t.folder_id
  , sf.local_path + isnull(replace(dbo.folder_path(t.folder_id), '/', '\'), '') as folder_path
  , t.file_id, ft.type_content, ft.open_comment, ft.close_comment
  , sf.local_path + replace(isnull(dbo.folder_path(f.folder_id), '\') + f.file_name, '/', '\') as file_path
  , tn.file_id as file_id_notes
  , sf.local_path + replace(isnull(dbo.folder_path(fn.folder_id), '\') + fn.file_name, '/', '\') as file_path_notes
 from dn_tasks t
 left join synch_folders sf on sf.synch_folder_id = t.synch_folder_id
 left join dn_files f on f.file_id = t.file_id
 left join dn_files_types ft on ft.extension = f.extension
 left join dn_tasks_notes tn on tn.task_id = t.task_id
 left join dn_files fn on fn.file_id = tn.file_id
 where t.task_id = 47
2021-01-06 16:07:56,093 [8] DEBUG dn_lib.tools.log - SQL: declare @id bigint; declare @tp varchar(10); declare @cc int; declare @content_lwt varchar(25);
      select top 1 @id = file_id from dn_files where synch_folder_id = 1 and folder_id = 119 and file_name = 'i.txt';
      if(@id is null)
      begin
        insert into dn_files (synch_folder_id, folder_id, file_name, extension, readed, dt_ins, dt_upd)
          values (1, 119, 'i.txt', '.txt', 1, convert(datetime, '2021-01-06 16:07:56', 120), convert(datetime, '2021-01-06 16:07:56', 120));
        select @id = @@IDENTITY, @tp = 'insert', @cc = 1;  
      end
      else 
      begin
       update dn_files set readed = 1 where file_id = @id;
       set ROWCOUNT 0;
       update dn_files set dt_ins = convert(datetime, '2021-01-06 16:07:56', 120), dt_upd = convert(datetime, '2021-01-06 16:07:56', 120) 
        where file_id = @id and ( isnull(dt_ins, getdate()) <> isnull(convert(datetime, '2021-01-06 16:07:56', 120), getdate())
         or isnull(dt_upd, getdate()) <> isnull(convert(datetime, '2021-01-06 16:07:56', 120), getdate()));
       select @tp = 'update', @cc = @@ROWCOUNT;
       select @content_lwt = convert(varchar, dt_upd, 120) from dn_files_contents where file_id = @id;
      end
      select @id, @tp, @cc, @content_lwt;
2021-01-06 16:07:56,100 [8] DEBUG dn_lib.tools.log - SQL: delete from dn_files_contents where file_id = 15;
        insert into dn_files_contents (file_id, extension, content, dt_ins, dt_upd)
          values (15, '.txt', @content, convert(datetime, '2021-01-06 16:07:56', 120), convert(datetime, '2021-01-06 16:07:56', 120));
2021-01-06 16:07:56,104 [8] DEBUG dn_lib.tools.log - SQL: delete from dn_tasks_notes where task_id = 47;
      insert into dn_tasks_notes (task_id, file_id, content, dt_ins, dt_upd)
        values (47, 15, @content
          , convert(datetime, convert(varchar, getdate(), 120), 120), convert(datetime, convert(varchar, getdate(), 120), 120));
      update dn_tasks set dt_upd = convert(datetime, convert(varchar, getdate(), 120), 120) where task_id = 47;
2021-01-06 16:08:07,979 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:07,981 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:07,982 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:07,983 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:07,984 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:07,985 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:07,986 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:07,986 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:07,988 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:07,989 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:07,990 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:07,991 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:07,991 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:07,992 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:07,993 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:07,994 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:07,995 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:07,995 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:07,996 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:07,996 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:07,997 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:07,997 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:07,998 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:07,999 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:07,999 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,000 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:08,022 [20] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:08,022 [20] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,023 [20] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,024 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,024 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,025 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,026 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,026 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,027 [20] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,028 [20] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,028 [20] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,029 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,029 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,030 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,031 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,031 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,032 [20] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,032 [20] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,033 [20] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,034 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,034 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,035 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,035 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,036 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,036 [20] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,037 [20] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:08,072 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:08,073 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,073 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,074 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,074 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,075 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,075 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,076 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,077 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,078 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,078 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,079 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,079 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,080 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,080 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,080 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,081 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,081 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:08,082 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:08,082 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:08,083 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:08,083 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:08,084 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:08,084 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:08,084 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:08,085 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:11,056 [25] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desiderio';
declare @sid varchar(100); set @sid = '1uf1rvyf0srmoupzq5vm4pn4';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:08:16,785 [25] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:08:17,316 [25] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:08:18,183 [25] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:08:18,202 [25] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:08:18,223 [25] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 3 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:08:19,646 [25] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:08:19,648 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:08:19,650 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:08:19,651 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:08:19,652 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:08:55,764 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:55,766 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,767 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,768 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,769 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,770 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,771 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,772 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,773 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,774 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,775 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,776 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,777 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,778 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,778 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,779 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,780 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,780 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,781 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,782 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,783 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,784 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,785 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,786 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,787 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,788 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:55,816 [26] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:55,816 [26] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,817 [26] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,817 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,818 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,819 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,819 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,820 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,820 [26] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,821 [26] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,821 [26] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,822 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,822 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,823 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,823 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,824 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,824 [26] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,825 [26] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,825 [26] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,826 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,826 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,827 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,827 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,827 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,828 [26] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,828 [26] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:55,864 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:08:55,865 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,865 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,866 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,866 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,867 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,867 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,868 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,868 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,869 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,869 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,870 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,870 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,871 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,871 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,872 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,872 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,872 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:08:55,873 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:08:55,873 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:08:55,874 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:08:55,874 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:08:55,875 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:08:55,875 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:08:55,876 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:08:55,877 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:08:59,024 [25] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = '1uf1rvyf0srmoupzq5vm4pn4';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:09:02,880 [25] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:09:02,883 [25] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:09:02,886 [25] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:09:02,901 [25] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:09:02,920 [25] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 3 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:09:02,938 [25] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:09:02,943 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:09:02,946 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:09:02,948 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:09:02,951 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:09:12,321 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:12,323 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,324 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,325 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,326 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,327 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,327 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,327 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,329 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,330 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,330 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,330 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,331 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,332 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,333 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,334 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,334 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,335 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,336 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,337 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,337 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,339 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,339 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,339 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,339 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,340 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:12,370 [20] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:12,371 [20] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,372 [20] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,372 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,373 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,374 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,374 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,375 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,375 [20] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,376 [20] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,376 [20] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,377 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,377 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,378 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,378 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,379 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,379 [20] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,380 [20] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,381 [20] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,382 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,382 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,383 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,384 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,384 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,385 [20] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,386 [20] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:12,426 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:12,427 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,428 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,428 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,429 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,430 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,431 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,432 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,433 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,434 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,434 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,435 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,436 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,436 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,437 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,437 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,438 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,439 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:12,439 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:12,440 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:12,440 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:12,441 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:12,442 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:12,442 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:12,443 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:12,443 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:14,655 [25] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desir';
declare @sid varchar(100); set @sid = '1uf1rvyf0srmoupzq5vm4pn4';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:09:18,447 [25] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:09:18,448 [25] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:09:18,450 [25] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:09:18,451 [25] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 3 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:09:18,453 [25] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 3 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:09:18,454 [25] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:09:18,455 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:09:18,456 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:09:18,457 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:09:18,458 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:09:49,937 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:49,938 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:49,939 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:49,940 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:49,941 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:49,942 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:49,943 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:49,944 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:49,945 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:49,945 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:49,946 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:49,946 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:49,947 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:49,947 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:49,948 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:49,948 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:49,949 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:49,949 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:49,950 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:49,950 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:49,951 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:49,951 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:49,952 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:49,952 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:49,953 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:49,954 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:49,989 [20] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:49,990 [20] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:49,991 [20] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:49,992 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:49,992 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:49,993 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:49,994 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:49,994 [20] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:49,995 [20] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:49,995 [20] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:49,996 [20] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:49,997 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:49,997 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:49,998 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:49,998 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:49,999 [20] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:49,999 [20] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:49,999 [20] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:50,000 [20] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:50,000 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:50,001 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:50,001 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:50,002 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:50,002 [20] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:50,003 [20] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:50,003 [20] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:50,041 [25] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:09:50,042 [25] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:50,043 [25] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:50,044 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:50,045 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:50,046 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:50,046 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:50,047 [25] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:50,048 [25] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:50,048 [25] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:50,049 [25] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:50,050 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:50,050 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:50,051 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:50,052 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:50,053 [25] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:50,055 [25] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:50,056 [25] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:09:50,057 [25] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:09:50,057 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:09:50,058 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:09:50,060 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:09:50,061 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:09:50,062 [25] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:09:50,063 [25] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:09:50,064 [25] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:09:56,959 [25] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:09:56,963 [25] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:09:56,965 [25] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:09:56,975 [25] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:09:56,981 [25] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:09:57,000 [25] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:09:57,006 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:09:57,009 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:09:57,012 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:09:57,014 [25] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:16:54,468 [17] INFO dn_lib.tools.log - reload core
2021-01-06 16:16:54,501 [17] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:16:54,505 [17] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,507 [17] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,508 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,519 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,522 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,535 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,544 [17] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,546 [17] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,547 [17] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,549 [17] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,550 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,550 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,552 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,553 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,554 [17] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,554 [17] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,555 [17] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,562 [17] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,564 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,565 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,566 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,567 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,568 [17] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,569 [17] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,571 [17] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:16:54,611 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:16:54,612 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,613 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,614 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,614 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,615 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,616 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,616 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,617 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,618 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,618 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,619 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,619 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,620 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,620 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,621 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,622 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,622 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,623 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,624 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,625 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,625 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,626 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,626 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,627 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,627 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:16:54,662 [40] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:16:54,663 [40] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,664 [40] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,665 [40] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,666 [40] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,666 [40] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,667 [40] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,668 [40] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,668 [40] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,669 [40] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,670 [40] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,670 [40] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,671 [40] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,671 [40] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,672 [40] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,672 [40] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,673 [40] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,674 [40] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:16:54,675 [40] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:16:54,676 [40] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:16:54,677 [40] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:16:54,677 [40] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:16:54,678 [40] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:16:54,679 [40] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:16:54,679 [40] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:16:54,684 [40] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:16:54,706 [40] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:16:54,712 [40] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:16:54,718 [40] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:16:54,730 [40] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:16:54,738 [40] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:16:54,767 [40] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:16:54,782 [40] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:16:54,865 [40] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:16:54,868 [40] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:16:54,871 [40] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:38:55,044 [7] INFO dn_lib.tools.log - reload core
2021-01-06 16:38:55,074 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:38:55,076 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:55,077 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:55,078 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:55,079 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:55,080 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:55,081 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:55,081 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:55,083 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:55,084 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:55,085 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:55,086 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:55,086 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:55,087 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:55,088 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:55,088 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:55,089 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:55,089 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:55,095 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:55,096 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:55,096 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:55,098 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:55,098 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:55,099 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:55,099 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:55,103 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:38:55,190 [7] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 45
2021-01-06 16:38:55,193 [7] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 45
2021-01-06 16:38:58,602 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:38:58,603 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:58,605 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:58,607 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:58,608 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:58,609 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:58,610 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:58,612 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:58,612 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:58,613 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:58,614 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:58,614 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:58,615 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:58,616 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:58,617 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:58,617 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:58,618 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:58,618 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:38:58,618 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:38:58,619 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:38:58,619 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:38:58,620 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:38:58,620 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:38:58,621 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:38:58,621 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:38:58,622 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:38:58,631 [7] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 48
2021-01-06 16:38:58,632 [7] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 48
2021-01-06 16:39:02,852 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:39:02,854 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:02,855 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:02,856 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:02,856 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:02,857 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:02,858 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:02,858 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:02,859 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:02,860 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:02,860 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:02,860 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:02,861 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:02,862 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:02,862 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:02,862 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:02,863 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:02,863 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:02,864 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:02,864 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:02,864 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:02,865 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:02,866 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:02,866 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:02,866 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:02,867 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:39:02,881 [8] DEBUG dn_lib.tools.log - SQL: select t.synch_folder_id, t.task_id, t.title, f.folder_id as parent_folder_id, t.folder_id
  , sf.local_path + isnull(replace(dbo.folder_path(t.folder_id), '/', '\'), '') as folder_path
  , t.file_id, ft.type_content, ft.open_comment, ft.close_comment
  , sf.local_path + replace(isnull(dbo.folder_path(f.folder_id), '\') + f.file_name, '/', '\') as file_path
  , tn.file_id as file_id_notes
  , sf.local_path + replace(isnull(dbo.folder_path(fn.folder_id), '\') + fn.file_name, '/', '\') as file_path_notes
 from dn_tasks t
 left join synch_folders sf on sf.synch_folder_id = t.synch_folder_id
 left join dn_files f on f.file_id = t.file_id
 left join dn_files_types ft on ft.extension = f.extension
 left join dn_tasks_notes tn on tn.task_id = t.task_id
 left join dn_files fn on fn.file_id = tn.file_id
 where t.task_id = 48
2021-01-06 16:39:02,908 [8] DEBUG dn_lib.tools.log - SQL: delete from dn_files_contents where file_id = 14;
        insert into dn_files_contents (file_id, extension, content, dt_ins, dt_upd)
          values (14, '.txt', @content, convert(datetime, '2021-01-06 16:39:02', 120), convert(datetime, '2021-01-06 16:39:02', 120));
2021-01-06 16:39:02,912 [8] DEBUG dn_lib.tools.log - SQL: delete from dn_tasks_notes where task_id = 48;
      insert into dn_tasks_notes (task_id, file_id, content, dt_ins, dt_upd)
        values (48, 14, @content
          , convert(datetime, convert(varchar, getdate(), 120), 120), convert(datetime, convert(varchar, getdate(), 120), 120));
      update dn_tasks set dt_upd = convert(datetime, convert(varchar, getdate(), 120), 120) where task_id = 48;
2021-01-06 16:39:15,018 [14] INFO dn_lib.tools.log - reload core
2021-01-06 16:39:15,052 [14] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:39:15,054 [14] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,055 [14] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,056 [14] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,058 [14] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,060 [14] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,069 [14] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,071 [14] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,073 [14] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,074 [14] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,076 [14] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,076 [14] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,077 [14] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,079 [14] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,080 [14] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,081 [14] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,082 [14] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,082 [14] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,088 [14] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,090 [14] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,091 [14] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,092 [14] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,093 [14] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,094 [14] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,095 [14] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,099 [14] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:39:15,143 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:39:15,144 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,145 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,146 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,146 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,147 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,148 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,148 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,149 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,149 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,150 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,150 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,151 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,151 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,152 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,152 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,153 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,153 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,154 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,155 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,155 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,156 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,157 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,158 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,159 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,159 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:39:15,180 [11] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:39:15,181 [11] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,182 [11] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,182 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,184 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,184 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,185 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,185 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,186 [11] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,186 [11] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,187 [11] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,187 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,188 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,188 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,189 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,189 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,190 [11] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,190 [11] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:39:15,191 [11] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:39:15,192 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:39:15,193 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:39:15,193 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:39:15,194 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:39:15,194 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:39:15,195 [11] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:39:15,195 [11] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:39:15,208 [11] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:39:15,250 [11] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:39:15,253 [11] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:39:15,259 [11] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:39:15,277 [11] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:39:15,298 [11] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:39:15,326 [11] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:39:15,342 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:39:15,426 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:39:15,429 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:39:15,431 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:40:28,153 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:28,154 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,155 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,156 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,156 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,157 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,157 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,158 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,159 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,159 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,160 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,160 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,161 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,162 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,162 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,163 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,163 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,164 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,165 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,165 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,166 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,166 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,167 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,167 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,168 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,168 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:28,214 [10] DEBUG dn_lib.tools.log - SQL: if not exists (select top 1 1 from users_cache where [user_id] = 0 and var_name = 'active-task-filter')
        insert into users_cache ([user_id], var_name, var_value)
          values (0, 'active-task-filter', '11')
        else update users_cache set var_value = substring('11', 1, 500), dt_upd = getdate()
          where [user_id] = 0 and var_name = 'active-task-filter'
2021-01-06 16:40:28,284 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:28,285 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,286 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,288 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,289 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,290 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,291 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,291 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,292 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,293 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,294 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,294 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,295 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,295 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,296 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,298 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,299 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,299 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:28,300 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:28,301 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:28,301 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:28,302 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:28,302 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:28,303 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:28,303 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:28,304 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:28,314 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:40:28,334 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:40:28,336 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:28,338 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:28,339 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:28,341 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:40:28,357 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:40:28,379 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:40:28,396 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:40:28,400 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:40:28,403 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:40:28,405 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:40:28,408 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:40:33,919 [18] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:33,920 [18] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,921 [18] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,923 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,924 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,924 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,925 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,926 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,926 [18] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,928 [18] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,929 [18] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,930 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,931 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,931 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,932 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,932 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,933 [18] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,933 [18] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,934 [18] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,934 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,935 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,935 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,936 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,936 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,937 [18] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,937 [18] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:33,950 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:33,951 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,952 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,952 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,953 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,953 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,954 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,955 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,955 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,957 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,957 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,957 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,957 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,958 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,958 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,959 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,959 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,959 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,960 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,961 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,961 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,962 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,962 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,963 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,963 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,964 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:33,976 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:33,977 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,979 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,979 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,980 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,981 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,981 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,982 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,982 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,983 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,983 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,984 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,985 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,985 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,986 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,986 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,986 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,987 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:33,987 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:33,988 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:33,988 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:33,989 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:33,989 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:33,990 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:33,990 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:33,991 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:34,000 [10] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:40:34,002 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:34,003 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:34,003 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:34,004 [10] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:40:34,010 [10] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:40:34,017 [10] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 16:40:34,041 [10] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:40:34,045 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:40:34,046 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:40:34,049 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:40:34,050 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:40:46,590 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:46,591 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,592 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,594 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,594 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,596 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,596 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,597 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,598 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,598 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,598 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,599 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,600 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,600 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,600 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,600 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,601 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,601 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,602 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,602 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,603 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,603 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,604 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,604 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,604 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,605 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:46,618 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:46,619 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,620 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,621 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,621 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,622 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,622 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,623 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,623 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,624 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,625 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,625 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,626 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,626 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,627 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,628 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,629 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,629 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,630 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,631 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,631 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,632 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,632 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,633 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,633 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,634 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:46,645 [18] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:40:46,646 [18] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,647 [18] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,648 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,648 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,649 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,650 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,650 [18] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,651 [18] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,651 [18] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,652 [18] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,652 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,653 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,653 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,653 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,654 [18] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,654 [18] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,655 [18] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:40:46,655 [18] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:40:46,656 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:40:46,656 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:40:46,657 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:40:46,657 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:40:46,658 [18] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:40:46,658 [18] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:40:46,659 [18] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:40:46,669 [18] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:40:46,670 [18] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:40:46,671 [18] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:46,672 [18] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:46,673 [18] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:40:46,673 [18] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:40:46,675 [18] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:40:46,676 [18] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:40:46,678 [18] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:40:46,680 [18] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:40:46,681 [18] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:40:46,682 [18] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:40:46,683 [18] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:46:57,650 [36] INFO dn_lib.tools.log - reload core
2021-01-06 16:46:57,681 [36] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:46:57,683 [36] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:46:57,684 [36] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:46:57,685 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:46:57,688 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:46:57,689 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:46:57,698 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:46:57,701 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:46:57,703 [36] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:46:57,704 [36] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:46:57,706 [36] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:46:57,706 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:46:57,707 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:46:57,708 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:46:57,709 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:46:57,710 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:46:57,712 [36] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:46:57,713 [36] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:46:57,719 [36] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:46:57,721 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:46:57,722 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:46:57,723 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:46:57,724 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:46:57,725 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:46:57,726 [36] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:46:57,740 [36] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:46:57,773 [36] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:46:57,794 [36] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:46:57,797 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:46:57,800 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:46:57,801 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:46:57,804 [36] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:46:57,822 [36] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:46:57,845 [36] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:46:57,871 [36] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:46:57,885 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:46:57,964 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:46:57,966 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:46:57,969 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:48:24,128 [10] INFO dn_lib.tools.log - reload core
2021-01-06 16:48:24,160 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:48:24,162 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:24,163 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:24,164 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:24,166 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:24,167 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:24,177 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:24,178 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:24,180 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:24,181 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:24,183 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:24,183 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:24,184 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:24,186 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:24,187 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:24,188 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:24,189 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:24,190 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:24,196 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:24,197 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:24,199 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:24,200 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:24,202 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:24,203 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:24,203 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:24,208 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:48:24,241 [10] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:48:24,263 [10] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:48:24,267 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:24,269 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:24,271 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:24,274 [10] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:48:24,291 [10] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:48:24,311 [10] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:48:24,337 [10] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:48:24,349 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:48:24,431 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:48:24,433 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:48:24,436 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:48:39,326 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:48:39,327 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:39,328 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:39,329 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:39,330 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:39,331 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:39,332 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:39,333 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:39,334 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:39,335 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:39,336 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:39,337 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:39,338 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:39,338 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:39,339 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:39,340 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:39,340 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:39,341 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:48:39,341 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:48:39,342 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:48:39,342 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:48:39,343 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:48:39,343 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:48:39,344 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:48:39,344 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:48:39,345 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:48:39,364 [10] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:48:39,365 [10] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:48:39,367 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:39,368 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:39,369 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:48:39,370 [10] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:48:39,372 [10] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:48:39,373 [10] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:48:39,379 [10] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:48:39,388 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:48:39,389 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:48:39,391 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:48:39,393 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:49:10,962 [35] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:10,963 [35] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:10,964 [35] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:10,965 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:10,965 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:10,966 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:10,967 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:10,967 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:10,968 [35] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:10,968 [35] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:10,969 [35] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:10,969 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:10,970 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:10,970 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:10,970 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:10,971 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:10,971 [35] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:10,972 [35] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:10,972 [35] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:10,973 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:10,973 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:10,974 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:10,974 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:10,974 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:10,975 [35] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:10,985 [35] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:10,996 [35] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'ina';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:49:11,017 [35] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:49:11,019 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:11,022 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:11,023 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:11,024 [35] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:49:11,041 [35] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:49:11,062 [35] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:49:11,079 [35] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:49:11,083 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:49:11,086 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:49:11,089 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:49:11,090 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:49:24,438 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:24,439 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,440 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,442 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,443 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,443 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,444 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,445 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,446 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,446 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,447 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,448 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,448 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,449 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,449 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,450 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,450 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,450 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,451 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,451 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,452 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,452 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,453 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,453 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,454 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,454 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:24,475 [57] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:24,476 [57] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,477 [57] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,478 [57] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,479 [57] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,479 [57] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,480 [57] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,481 [57] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,481 [57] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,482 [57] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,483 [57] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,483 [57] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,484 [57] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,484 [57] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,485 [57] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,485 [57] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,486 [57] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,486 [57] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,486 [57] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,487 [57] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,488 [57] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,488 [57] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,489 [57] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,489 [57] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,490 [57] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,491 [57] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:24,513 [56] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:24,514 [56] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,515 [56] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,516 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,517 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,518 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,518 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,519 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,519 [56] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,520 [56] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,520 [56] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,521 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,521 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,522 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,522 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,522 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,523 [56] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,523 [56] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:24,524 [56] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:24,524 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:24,525 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:24,526 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:24,526 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:24,527 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:24,528 [56] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:24,528 [56] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:24,537 [56] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:49:24,538 [56] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:24,539 [56] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:24,540 [56] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:24,541 [56] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:49:24,547 [56] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:49:24,553 [56] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 16:49:24,571 [56] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:49:24,575 [56] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:49:24,576 [56] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:49:24,578 [56] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:49:24,579 [56] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:49:37,893 [56] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:37,895 [56] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,896 [56] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,897 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,898 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,898 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,899 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,900 [56] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,901 [56] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,902 [56] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,902 [56] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,903 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,904 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,904 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,905 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,905 [56] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,906 [56] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,907 [56] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,907 [56] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,907 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,908 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,908 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,909 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,909 [56] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,910 [56] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,910 [56] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:37,925 [12] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:37,926 [12] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,926 [12] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,927 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,927 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,928 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,929 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,929 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,930 [12] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,930 [12] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,930 [12] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,931 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,931 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,932 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,932 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,933 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,933 [12] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,934 [12] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,934 [12] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,935 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,935 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,936 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,936 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,937 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,937 [12] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,938 [12] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:37,950 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:49:37,951 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,951 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,952 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,952 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,953 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,953 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,954 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,955 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,955 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,956 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,956 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,957 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,958 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,958 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,959 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,959 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,960 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:49:37,960 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:49:37,961 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:49:37,961 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:49:37,962 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:49:37,962 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:49:37,963 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:49:37,963 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:49:37,964 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:49:37,973 [13] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:49:38,007 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:49:38,008 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:38,009 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:38,010 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:49:38,011 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:49:38,013 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:49:38,014 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:49:38,016 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:49:38,019 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:49:38,020 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:49:38,021 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:49:38,022 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:52:35,387 [35] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:52:35,388 [35] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:52:35,389 [35] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:52:35,391 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:52:35,392 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:52:35,393 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:52:35,394 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:52:35,394 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:52:35,395 [35] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:52:35,396 [35] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:52:35,397 [35] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:52:35,398 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:52:35,399 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:52:35,399 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:52:35,400 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:52:35,400 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:52:35,401 [35] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:52:35,402 [35] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:52:35,402 [35] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:52:35,403 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:52:35,403 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:52:35,404 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:52:35,404 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:52:35,405 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:52:35,405 [35] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:52:35,417 [35] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:52:35,425 [35] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:52:35,447 [35] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:52:35,449 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:52:35,450 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:52:35,451 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:52:35,452 [35] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:52:35,469 [35] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:52:35,488 [35] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:52:35,505 [35] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:52:35,508 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:52:35,511 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:52:35,513 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:52:35,516 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:53:10,089 [59] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:53:10,091 [59] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:10,091 [59] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:10,091 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:10,092 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:10,093 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:10,094 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:10,095 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:10,096 [59] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:10,097 [59] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:10,098 [59] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:10,099 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:10,099 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:10,099 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:10,100 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:10,100 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:10,101 [59] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:10,102 [59] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:10,102 [59] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:10,103 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:10,103 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:10,104 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:10,104 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:10,105 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:10,106 [59] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:10,115 [59] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:53:10,127 [59] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:53:10,129 [59] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:53:10,130 [59] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:10,131 [59] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:10,132 [59] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:10,133 [59] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:53:10,134 [59] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:53:10,136 [59] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:53:10,136 [59] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:53:10,140 [59] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:53:10,141 [59] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:53:10,141 [59] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:53:10,143 [59] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:53:19,139 [12] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:53:19,140 [12] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:19,140 [12] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:19,141 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:19,142 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:19,142 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:19,143 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:19,144 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:19,144 [12] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:19,145 [12] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:19,145 [12] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:19,146 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:19,146 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:19,146 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:19,147 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:19,147 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:19,148 [12] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:19,148 [12] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:19,149 [12] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:19,149 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:19,150 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:19,150 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:19,151 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:19,151 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:19,151 [12] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:19,162 [12] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:53:19,174 [12] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:53:19,193 [12] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:53:19,195 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:19,197 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:19,198 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:19,199 [12] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:53:19,216 [12] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:53:19,234 [12] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:53:19,252 [12] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:53:19,255 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:53:19,258 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:53:19,260 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:53:19,263 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:53:49,266 [36] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:53:49,267 [36] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:49,267 [36] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:49,268 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:49,269 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:49,270 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:49,271 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:49,272 [36] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:49,273 [36] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:49,273 [36] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:49,274 [36] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:49,275 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:49,276 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:49,276 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:49,277 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:49,277 [36] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:49,278 [36] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:49,278 [36] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:49,279 [36] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:49,279 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:49,280 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:49,281 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:49,281 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:49,282 [36] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:49,283 [36] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:49,293 [36] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:53:49,305 [36] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:53:49,325 [36] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:53:49,328 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:49,330 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:49,330 [36] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:49,331 [36] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:53:49,348 [36] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:53:49,367 [36] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:53:49,382 [36] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:53:49,386 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:53:49,388 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:53:49,391 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:53:49,393 [36] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 16:53:53,831 [12] INFO dn_lib.tools.log - reload config docs
2021-01-06 16:53:53,833 [12] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:53,834 [12] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:53,835 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:53,836 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:53,837 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:53,838 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:53,839 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:53,839 [12] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:53,840 [12] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:53,840 [12] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:53,841 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:53,841 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:53,842 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:53,842 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:53,843 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:53,843 [12] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:53,844 [12] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 16:53:53,844 [12] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 16:53:53,845 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 16:53:53,845 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 16:53:53,846 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 16:53:53,846 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 16:53:53,846 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 16:53:53,846 [12] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 16:53:53,856 [12] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 16:53:53,867 [12] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 16:53:53,869 [12] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 16:53:53,870 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:53,871 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:53,872 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 16:53:53,873 [12] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 16:53:53,875 [12] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 16:53:53,876 [12] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 16:53:53,877 [12] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 16:53:53,880 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 16:53:53,881 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 16:53:53,882 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 16:53:53,883 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:02:34,913 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:02:34,914 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:34,915 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:34,916 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:34,917 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:34,917 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:34,918 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:34,919 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:34,919 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:34,920 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:34,920 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:34,921 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:34,921 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:34,922 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:34,923 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:34,923 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:34,924 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:34,924 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:34,925 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:34,925 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:34,926 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:34,926 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:34,927 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:34,927 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:34,928 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:34,938 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:02:34,948 [66] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:02:34,968 [66] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:02:34,971 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:34,973 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:34,974 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:34,975 [66] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:02:34,992 [66] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:02:35,010 [66] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:02:35,027 [66] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:02:35,031 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:02:35,034 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:02:35,036 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:02:35,039 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:02:42,119 [87] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:02:42,120 [87] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:42,121 [87] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:42,122 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:42,123 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:42,123 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:42,124 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:42,125 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:42,126 [87] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:42,127 [87] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:42,127 [87] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:42,128 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:42,129 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:42,130 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:42,130 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:42,131 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:42,132 [87] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:42,132 [87] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:42,133 [87] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:42,133 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:42,134 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:42,134 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:42,135 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:42,135 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:42,135 [87] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:42,145 [87] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:02:42,161 [87] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:02:42,162 [87] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:02:42,164 [87] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:42,164 [87] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:42,166 [87] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:42,167 [87] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:02:42,168 [87] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:02:42,170 [87] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:02:42,171 [87] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:02:42,174 [87] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:02:42,175 [87] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:02:42,176 [87] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:02:42,177 [87] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:02:52,480 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:02:52,482 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:52,482 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:52,483 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:52,484 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:52,484 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:52,485 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:52,486 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:52,486 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:52,487 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:52,488 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:52,488 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:52,489 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:52,489 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:52,490 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:52,490 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:52,491 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:52,491 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:52,492 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:52,492 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:52,493 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:52,493 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:52,495 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:52,495 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:52,496 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:52,505 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:02:52,518 [13] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:02:52,520 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:02:52,521 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:52,521 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:52,522 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:52,523 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:02:52,524 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:02:52,525 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:02:52,527 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:02:52,530 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:02:52,531 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:02:52,532 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:02:52,532 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:02:58,526 [74] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:02:58,528 [74] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:58,528 [74] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:58,529 [74] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:58,529 [74] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:58,530 [74] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:58,532 [74] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:58,532 [74] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:58,533 [74] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:58,533 [74] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:58,534 [74] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:58,535 [74] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:58,535 [74] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:58,536 [74] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:58,536 [74] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:58,537 [74] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:58,537 [74] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:58,537 [74] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:02:58,538 [74] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:02:58,538 [74] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:02:58,539 [74] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:02:58,539 [74] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:02:58,540 [74] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:02:58,540 [74] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:02:58,541 [74] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:02:58,550 [74] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:02:58,563 [74] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:02:58,564 [74] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:02:58,564 [74] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:58,566 [74] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:58,567 [74] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:02:58,567 [74] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:02:58,569 [74] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:02:58,570 [74] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:02:58,571 [74] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:02:58,574 [74] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:02:58,575 [74] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:02:58,576 [74] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:02:58,577 [74] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:03:05,512 [19] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:03:05,513 [19] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:03:05,514 [19] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:03:05,515 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:03:05,515 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:03:05,516 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:03:05,517 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:03:05,518 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:03:05,519 [19] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:03:05,520 [19] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:03:05,521 [19] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:03:05,521 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:03:05,522 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:03:05,522 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:03:05,523 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:03:05,523 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:03:05,524 [19] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:03:05,525 [19] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:03:05,526 [19] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:03:05,526 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:03:05,527 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:03:05,527 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:03:05,528 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:03:05,528 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:03:05,528 [19] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:03:05,539 [19] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:03:05,553 [19] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'desi';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:03:05,554 [19] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:03:05,555 [19] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:03:05,556 [19] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:03:05,557 [19] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:03:05,558 [19] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:03:05,560 [19] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:03:05,562 [19] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:03:05,563 [19] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:03:05,566 [19] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:03:05,567 [19] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:03:05,568 [19] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:03:05,569 [19] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:04:44,019 [59] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:44,020 [59] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,021 [59] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,022 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,023 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,023 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,024 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,025 [59] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,026 [59] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,027 [59] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,027 [59] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,028 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,029 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,030 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,030 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,031 [59] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,031 [59] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,032 [59] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,032 [59] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,033 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,033 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,034 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,035 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,035 [59] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,036 [59] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,046 [59] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:44,083 [101] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:44,084 [101] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,085 [101] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,086 [101] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,086 [101] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,087 [101] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,088 [101] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,089 [101] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,089 [101] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,090 [101] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,091 [101] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,093 [101] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,093 [101] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,094 [101] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,095 [101] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,096 [101] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,096 [101] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,097 [101] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,097 [101] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,098 [101] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,098 [101] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,099 [101] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,099 [101] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,100 [101] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,100 [101] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,101 [101] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:44,120 [12] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:44,121 [12] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,122 [12] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,123 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,123 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,124 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,125 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,126 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,127 [12] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,127 [12] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,128 [12] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,128 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,129 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,129 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,130 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,130 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,131 [12] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,131 [12] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:44,132 [12] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:44,132 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:44,133 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:44,134 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:44,134 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:44,135 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:44,135 [12] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:44,136 [12] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:44,144 [12] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:04:44,146 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:44,149 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:44,150 [12] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:44,151 [12] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:04:44,160 [12] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:04:44,166 [12] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 17:04:44,188 [12] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:04:44,199 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:04:44,202 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:04:44,204 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:04:44,207 [12] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:04:55,003 [19] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:55,004 [19] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,006 [19] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,007 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,008 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,009 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,010 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,010 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,012 [19] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,012 [19] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,013 [19] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,014 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,014 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,014 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,015 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,015 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,016 [19] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,016 [19] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,017 [19] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,017 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,018 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,018 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,019 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,019 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,020 [19] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,020 [19] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:55,032 [84] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:55,033 [84] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,034 [84] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,034 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,035 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,035 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,036 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,036 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,037 [84] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,038 [84] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,038 [84] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,038 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,039 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,039 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,040 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,041 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,042 [84] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,043 [84] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,043 [84] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,043 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,044 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,044 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,045 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,045 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,046 [84] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,046 [84] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:55,057 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:04:55,058 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,059 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,060 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,061 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,061 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,062 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,063 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,063 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,064 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,064 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,065 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,065 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,065 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,066 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,066 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,067 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,067 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:04:55,068 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:04:55,068 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:04:55,069 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:04:55,069 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:04:55,070 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:04:55,070 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:04:55,071 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:04:55,071 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:04:55,079 [66] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:04:55,111 [66] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:04:55,112 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:55,114 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:55,115 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:04:55,115 [66] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:04:55,130 [66] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:04:55,149 [66] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:04:55,164 [66] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:04:55,168 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:04:55,169 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:04:55,171 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:04:55,172 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:05:02,220 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:02,221 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:02,222 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:02,223 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:02,224 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:02,225 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:02,226 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:02,226 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:02,227 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:02,228 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:02,228 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:02,229 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:02,229 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:02,230 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:02,230 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:02,231 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:02,231 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:02,232 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:02,232 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:02,232 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:02,233 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:02,233 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:02,234 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:02,234 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:02,234 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:02,235 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:02,279 [66] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 46
2021-01-06 17:05:02,282 [66] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 46
2021-01-06 17:05:08,789 [35] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:08,791 [35] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:08,792 [35] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:08,793 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:08,794 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:08,796 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:08,797 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:08,798 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:08,798 [35] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:08,799 [35] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:08,799 [35] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:08,800 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:08,800 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:08,800 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:08,801 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:08,801 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:08,802 [35] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:08,802 [35] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:08,802 [35] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:08,803 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:08,803 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:08,804 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:08,804 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:08,804 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:08,805 [35] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:08,805 [35] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:08,813 [35] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 48
2021-01-06 17:05:08,814 [35] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 48
2021-01-06 17:05:10,480 [99] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:10,482 [99] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:10,484 [99] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:10,485 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:10,486 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:10,487 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:10,488 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:10,489 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:10,490 [99] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:10,490 [99] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:10,491 [99] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:10,492 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:10,492 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:10,493 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:10,493 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:10,494 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:10,494 [99] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:10,495 [99] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:10,495 [99] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:10,496 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:10,496 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:10,497 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:10,497 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:10,498 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:10,498 [99] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:10,499 [99] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:10,506 [99] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 47
2021-01-06 17:05:10,508 [99] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 47
2021-01-06 17:05:34,013 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:34,014 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,015 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,016 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,017 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,018 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,019 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,019 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,020 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,021 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,021 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,022 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,022 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,023 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,023 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,024 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,024 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,025 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,025 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,025 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,026 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,027 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,028 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,029 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,029 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,030 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:34,041 [19] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:34,042 [19] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,043 [19] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,044 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,044 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,045 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,046 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,047 [19] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,047 [19] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,048 [19] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,049 [19] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,049 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,050 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,051 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,051 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,052 [19] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,052 [19] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,053 [19] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,053 [19] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,054 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,054 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,055 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,055 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,056 [19] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,056 [19] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,057 [19] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:34,068 [84] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:34,069 [84] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,070 [84] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,071 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,071 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,072 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,072 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,073 [84] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,073 [84] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,074 [84] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,074 [84] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,075 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,075 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,075 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,076 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,076 [84] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,077 [84] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,077 [84] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:34,078 [84] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:34,078 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:34,079 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:34,079 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:34,080 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:34,080 [84] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:34,081 [84] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:34,081 [84] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:34,090 [84] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:05:34,114 [84] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:05:34,116 [84] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:05:34,118 [84] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:05:34,119 [84] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:05:34,120 [84] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:05:34,136 [84] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:05:34,155 [84] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:05:34,171 [84] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:05:34,174 [84] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:05:34,176 [84] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:05:34,179 [84] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:05:34,180 [84] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:05:36,634 [99] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:05:36,636 [99] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:36,637 [99] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:36,638 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:36,639 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:36,640 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:36,640 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:36,641 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:36,642 [99] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:36,643 [99] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:36,643 [99] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:36,644 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:36,644 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:36,645 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:36,645 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:36,646 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:36,646 [99] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:36,647 [99] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:05:36,647 [99] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:05:36,648 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:05:36,649 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:05:36,650 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:05:36,651 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:05:36,651 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:05:36,652 [99] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:05:36,652 [99] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:05:36,660 [99] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 46
2021-01-06 17:05:36,661 [99] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 46
2021-01-06 17:07:20,313 [100] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:07:20,313 [100] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:20,314 [100] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:20,315 [100] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:20,316 [100] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:20,317 [100] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:20,318 [100] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:20,319 [100] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:20,320 [100] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:20,321 [100] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:20,321 [100] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:20,322 [100] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:20,323 [100] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:20,323 [100] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:20,324 [100] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:20,324 [100] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:20,325 [100] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:20,326 [100] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:20,326 [100] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:20,327 [100] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:20,328 [100] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:20,328 [100] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:20,329 [100] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:20,329 [100] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:20,330 [100] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:20,330 [100] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:07:20,348 [100] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:07:20,366 [100] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:07:20,369 [100] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:20,371 [100] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:20,372 [100] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:20,373 [100] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:07:20,390 [100] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:07:20,409 [100] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:07:20,429 [100] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:07:20,440 [100] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:07:20,443 [100] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:07:20,445 [100] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:07:20,447 [100] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:07:54,521 [99] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:07:54,522 [99] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:54,523 [99] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:54,524 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:54,525 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:54,525 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:54,526 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:54,527 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:54,528 [99] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:54,528 [99] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:54,529 [99] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:54,530 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:54,531 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:54,531 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:54,531 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:54,532 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:54,533 [99] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:54,533 [99] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:07:54,533 [99] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:07:54,534 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:07:54,534 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:07:54,535 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:07:54,535 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:07:54,536 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:07:54,536 [99] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:07:54,537 [99] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:07:54,555 [99] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:07:54,574 [99] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:07:54,577 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:54,579 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:54,580 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:07:54,582 [99] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:07:54,599 [99] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:07:54,617 [99] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:07:54,637 [99] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:07:54,646 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:07:54,649 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:07:54,652 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:07:54,654 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:08:03,199 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:08:03,200 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:03,201 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:03,202 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:03,203 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:03,204 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:03,205 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:03,205 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:03,206 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:03,207 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:03,207 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:03,208 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:03,208 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:03,209 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:03,210 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:03,211 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:03,211 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:03,212 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:03,213 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:03,214 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:03,214 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:03,214 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:03,215 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:03,216 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:03,216 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:03,217 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:08:03,224 [13] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:08:03,226 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:08:03,228 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:03,229 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:03,230 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:03,231 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:08:03,232 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:08:03,234 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:08:03,235 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:08:03,237 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:08:03,238 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:08:03,239 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:08:03,240 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:08:04,301 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:08:04,302 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:04,303 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:04,304 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:04,305 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:04,306 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:04,307 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:04,307 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:04,308 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:04,309 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:04,310 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:04,311 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:04,312 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:04,313 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:04,314 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:04,315 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:04,315 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:04,316 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:08:04,316 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:08:04,317 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:08:04,318 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:08:04,318 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:08:04,319 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:08:04,319 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:08:04,319 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:08:04,320 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:08:04,328 [66] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:08:04,330 [66] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:08:04,331 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:04,331 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:04,332 [66] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:08:04,333 [66] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:08:04,334 [66] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:08:04,335 [66] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:08:04,337 [66] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:08:04,338 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:08:04,339 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:08:04,340 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:08:04,341 [66] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:09:01,639 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:09:01,640 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:01,641 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:01,642 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:01,643 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:01,643 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:01,645 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:01,646 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:01,647 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:01,647 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:01,649 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:01,649 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:01,650 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:01,651 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:01,652 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:01,652 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:01,653 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:01,654 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:01,654 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:01,655 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:01,655 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:01,656 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:01,656 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:01,657 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:01,657 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:01,658 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:09:01,675 [13] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'corno';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:09:01,694 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:09:01,696 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:01,699 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:01,700 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:01,702 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:09:01,719 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:09:01,738 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:09:01,760 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:09:01,770 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:09:01,772 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:09:01,774 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:09:01,777 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:09:08,025 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:09:08,026 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,027 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,028 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,029 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,030 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,030 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,031 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,032 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,033 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,034 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,034 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,035 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,036 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,037 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,038 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,038 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,038 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,039 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,039 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,040 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,040 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,041 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,041 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,042 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,042 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:09:08,061 [99] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:09:08,062 [99] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,063 [99] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,064 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,065 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,065 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,067 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,067 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,068 [99] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,069 [99] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,070 [99] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,070 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,071 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,071 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,072 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,072 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,073 [99] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,073 [99] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:09:08,074 [99] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:09:08,074 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:09:08,075 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:09:08,075 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:09:08,076 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:09:08,077 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:09:08,077 [99] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:09:08,078 [99] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:09:08,086 [99] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:09:08,087 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:08,088 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:08,089 [99] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:09:08,089 [99] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:09:08,095 [99] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:09:08,106 [99] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 17:09:08,121 [99] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:09:08,123 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:09:08,125 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:09:08,126 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:09:08,127 [99] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:13:14,016 [71] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:14,017 [71] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:14,018 [71] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:14,019 [71] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:14,020 [71] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:14,021 [71] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:14,022 [71] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:14,023 [71] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:14,023 [71] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:14,024 [71] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:14,025 [71] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:14,026 [71] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:14,026 [71] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:14,027 [71] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:14,027 [71] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:14,028 [71] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:14,028 [71] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:14,029 [71] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:14,029 [71] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:14,030 [71] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:14,030 [71] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:14,031 [71] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:14,031 [71] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:14,032 [71] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:14,033 [71] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:14,043 [71] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:14,060 [71] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:13:14,063 [71] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:14,066 [71] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:14,067 [71] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:14,068 [71] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:13:14,078 [71] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:13:14,087 [71] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 17:13:14,108 [71] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:13:14,121 [71] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:13:14,123 [71] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:13:14,125 [71] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:13:14,128 [71] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:13:24,650 [83] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:24,651 [83] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,652 [83] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,654 [83] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,654 [83] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,655 [83] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,656 [83] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,657 [83] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,659 [83] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,660 [83] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,660 [83] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,661 [83] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,661 [83] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,662 [83] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,662 [83] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,662 [83] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,663 [83] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,663 [83] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,664 [83] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,664 [83] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,665 [83] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,665 [83] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,665 [83] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,666 [83] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,666 [83] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,667 [83] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:24,686 [87] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:24,687 [87] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,688 [87] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,689 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,690 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,692 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,693 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,693 [87] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,694 [87] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,694 [87] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,695 [87] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,695 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,696 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,696 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,697 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,697 [87] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,698 [87] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,698 [87] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,699 [87] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,699 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,700 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,700 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,700 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,701 [87] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,701 [87] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,702 [87] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:24,721 [35] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:24,722 [35] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,723 [35] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,724 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,726 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,726 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,727 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,728 [35] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,728 [35] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,730 [35] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,730 [35] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,731 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,732 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,732 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,733 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,733 [35] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,734 [35] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,734 [35] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:24,734 [35] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:24,735 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:24,736 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:24,736 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:24,737 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:24,737 [35] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:24,738 [35] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:24,739 [35] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:24,748 [35] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:13:24,749 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:24,750 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:24,751 [35] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:24,751 [35] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:13:24,758 [35] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:13:24,765 [35] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 17:13:24,782 [35] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:13:24,786 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:13:24,787 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:13:24,788 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:13:24,789 [35] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:13:53,495 [99] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:53,496 [99] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,497 [99] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,498 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,499 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,499 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,500 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,500 [99] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,501 [99] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,502 [99] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,503 [99] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,504 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,504 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,505 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,505 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,506 [99] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,506 [99] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,507 [99] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,507 [99] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,508 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,508 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,509 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,509 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,510 [99] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,510 [99] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,511 [99] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:53,522 [66] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:53,523 [66] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,523 [66] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,524 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,525 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,525 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,526 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,526 [66] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,527 [66] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,527 [66] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,528 [66] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,528 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,529 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,529 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,530 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,530 [66] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,531 [66] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,531 [66] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,532 [66] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,532 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,533 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,533 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,534 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,534 [66] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,535 [66] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,535 [66] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:53,549 [82] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:13:53,550 [82] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,550 [82] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,551 [82] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,552 [82] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,553 [82] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,554 [82] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,554 [82] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,555 [82] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,556 [82] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,556 [82] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,557 [82] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,557 [82] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,558 [82] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,558 [82] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,559 [82] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,559 [82] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,559 [82] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:13:53,560 [82] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:13:53,560 [82] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:13:53,561 [82] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:13:53,561 [82] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:13:53,561 [82] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:13:53,562 [82] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:13:53,562 [82] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:13:53,563 [82] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:13:53,573 [82] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:13:53,599 [82] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:13:53,600 [82] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:53,601 [82] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:53,602 [82] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:13:53,604 [82] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:13:53,616 [82] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:13:53,636 [82] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:13:53,652 [82] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:13:53,656 [82] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:13:53,657 [82] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:13:53,658 [82] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:13:53,659 [82] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:22:29,578 [67] INFO dn_lib.tools.log - reload core
2021-01-06 17:22:29,610 [67] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:22:29,612 [67] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:29,613 [67] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:29,614 [67] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:29,616 [67] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:29,623 [67] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:29,633 [67] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:29,636 [67] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:29,638 [67] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:29,639 [67] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:29,640 [67] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:29,641 [67] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:29,641 [67] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:29,643 [67] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:29,644 [67] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:29,644 [67] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:29,645 [67] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:29,646 [67] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:29,652 [67] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:29,655 [67] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:29,656 [67] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:29,657 [67] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:29,658 [67] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:29,659 [67] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:29,659 [67] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:29,663 [67] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:22:29,693 [67] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:22:29,714 [67] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:22:29,718 [67] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:29,721 [67] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:29,722 [67] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:29,725 [67] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:22:29,743 [67] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:22:29,765 [67] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:22:29,791 [67] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:22:29,806 [67] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:22:29,889 [67] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:22:29,892 [67] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:22:29,893 [67] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:22:35,699 [43] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:22:35,700 [43] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,702 [43] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,703 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,704 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,705 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,706 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,707 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,708 [43] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,709 [43] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,709 [43] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,710 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,710 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,711 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,712 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,712 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,713 [43] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,713 [43] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,714 [43] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,714 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,715 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,715 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,716 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,716 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,717 [43] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,719 [43] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:22:35,749 [50] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:22:35,751 [50] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,752 [50] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,753 [50] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,754 [50] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,755 [50] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,755 [50] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,756 [50] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,756 [50] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,757 [50] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,758 [50] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,758 [50] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,759 [50] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,759 [50] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,760 [50] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,760 [50] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,761 [50] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,761 [50] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:22:35,762 [50] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:22:35,762 [50] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:22:35,763 [50] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:22:35,763 [50] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:22:35,764 [50] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:22:35,764 [50] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:22:35,765 [50] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:22:35,765 [50] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:22:35,776 [50] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:22:35,777 [50] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:22:35,778 [50] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:35,779 [50] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:35,780 [50] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:22:35,780 [50] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:22:35,793 [50] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:22:35,811 [50] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:22:35,829 [50] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:22:35,831 [50] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:22:35,832 [50] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:22:35,834 [50] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:22:35,835 [50] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:23:44,127 [43] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:23:44,128 [43] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:44,129 [43] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:44,130 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:44,130 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:44,131 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:44,132 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:44,134 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:44,135 [43] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:44,135 [43] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:44,137 [43] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:44,138 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:44,138 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:44,139 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:44,139 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:44,140 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:44,140 [43] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:44,141 [43] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:44,141 [43] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:44,142 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:44,142 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:44,143 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:44,143 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:44,144 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:44,144 [43] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:44,145 [43] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:23:44,165 [43] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:23:44,185 [43] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:23:44,187 [43] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:44,189 [43] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:44,190 [43] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:44,192 [43] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:23:44,208 [43] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:23:44,225 [43] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:23:44,245 [43] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:23:44,256 [43] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:23:44,259 [43] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:23:44,261 [43] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:23:44,263 [43] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:23:46,236 [37] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:23:46,237 [37] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:46,238 [37] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:46,239 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:46,240 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:46,241 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:46,243 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:46,243 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:46,244 [37] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:46,244 [37] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:46,245 [37] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:46,245 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:46,245 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:46,246 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:46,246 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:46,247 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:46,247 [37] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:46,248 [37] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:46,248 [37] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:46,249 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:46,249 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:46,250 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:46,250 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:46,250 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:46,251 [37] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:46,251 [37] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:23:46,262 [37] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:23:46,263 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:46,264 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:46,265 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:46,266 [37] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:23:46,272 [37] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:23:46,282 [37] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 17:23:46,299 [37] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:23:46,301 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:23:46,302 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:23:46,303 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:23:46,304 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:23:57,415 [34] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:23:57,417 [34] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,418 [34] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,419 [34] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,420 [34] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,421 [34] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,422 [34] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,422 [34] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,423 [34] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,424 [34] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,424 [34] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,425 [34] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,426 [34] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,426 [34] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,427 [34] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,427 [34] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,428 [34] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,429 [34] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,429 [34] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,430 [34] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,430 [34] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,431 [34] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,431 [34] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,432 [34] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,432 [34] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,433 [34] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:23:57,453 [38] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:23:57,454 [38] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,455 [38] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,456 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,457 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,457 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,458 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,458 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,459 [38] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,459 [38] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,460 [38] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,460 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,461 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,462 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,462 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,463 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,463 [38] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,463 [38] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,464 [38] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,464 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,465 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,465 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,466 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,466 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,467 [38] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,467 [38] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:23:57,489 [37] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:23:57,490 [37] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,490 [37] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,491 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,492 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,492 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,493 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,494 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,494 [37] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,495 [37] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,495 [37] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,495 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,496 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,496 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,497 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,497 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,498 [37] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,498 [37] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:23:57,499 [37] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:23:57,499 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:23:57,500 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:23:57,500 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:23:57,501 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:23:57,501 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:23:57,501 [37] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:23:57,502 [37] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:23:57,512 [37] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:23:57,513 [37] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:23:57,514 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:57,515 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:57,515 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:23:57,516 [37] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:23:57,529 [37] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:23:57,549 [37] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:23:57,564 [37] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:23:57,569 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:23:57,570 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:23:57,572 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:23:57,573 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:24:00,513 [43] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:24:00,514 [43] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,515 [43] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,516 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,517 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,518 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,518 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,519 [43] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,520 [43] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,521 [43] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,522 [43] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,523 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,524 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,524 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,525 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,526 [43] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,526 [43] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,527 [43] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,527 [43] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,528 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,529 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,529 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,530 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,530 [43] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,531 [43] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,531 [43] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:24:00,544 [38] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:24:00,545 [38] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,546 [38] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,547 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,547 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,548 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,549 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,549 [38] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,550 [38] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,551 [38] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,551 [38] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,552 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,552 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,553 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,554 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,555 [38] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,555 [38] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,556 [38] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:24:00,557 [38] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:24:00,557 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:24:00,558 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:24:00,558 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:24:00,559 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:24:00,559 [38] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:24:00,559 [38] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:24:00,560 [38] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:24:00,569 [38] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:24:00,571 [38] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:24:00,573 [38] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:24:00,574 [38] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:24:00,575 [38] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:24:00,576 [38] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:24:00,577 [38] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:24:00,578 [38] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:24:00,579 [38] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:24:00,581 [38] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:24:00,582 [38] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:24:00,583 [38] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:24:00,583 [38] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:25:16,620 [37] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:25:16,621 [37] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:25:16,623 [37] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:25:16,623 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:25:16,623 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:25:16,625 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:25:16,626 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:25:16,627 [37] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:25:16,627 [37] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:25:16,628 [37] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:25:16,628 [37] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:25:16,629 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:25:16,630 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:25:16,630 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:25:16,631 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:25:16,632 [37] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:25:16,632 [37] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:25:16,633 [37] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:25:16,633 [37] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:25:16,634 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:25:16,635 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:25:16,635 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:25:16,635 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:25:16,636 [37] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:25:16,636 [37] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:25:16,646 [37] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:25:16,658 [37] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:25:16,683 [37] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:25:16,685 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:25:16,687 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:25:16,688 [37] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:25:16,689 [37] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:25:16,707 [37] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:25:16,725 [37] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:25:16,741 [37] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:25:16,744 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:25:16,746 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:25:16,749 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:25:16,751 [37] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:26:35,181 [21] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:26:35,183 [21] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:26:35,184 [21] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:26:35,185 [21] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:26:35,186 [21] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:26:35,186 [21] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:26:35,187 [21] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:26:35,188 [21] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:26:35,189 [21] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:26:35,190 [21] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:26:35,190 [21] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:26:35,191 [21] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:26:35,192 [21] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:26:35,192 [21] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:26:35,193 [21] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:26:35,193 [21] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:26:35,194 [21] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:26:35,195 [21] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:26:35,196 [21] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:26:35,196 [21] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:26:35,197 [21] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:26:35,197 [21] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:26:35,198 [21] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:26:35,198 [21] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:26:35,199 [21] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:26:35,210 [21] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:26:35,219 [21] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:26:35,240 [21] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:26:35,243 [21] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:26:35,245 [21] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:26:35,247 [21] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:26:35,248 [21] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:26:35,263 [21] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:26:35,286 [21] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:26:35,304 [21] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:26:35,307 [21] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:26:35,310 [21] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:26:35,312 [21] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:26:35,315 [21] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 17:33:12,862 [26] INFO dn_lib.tools.log - reload config docs
2021-01-06 17:33:12,864 [26] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:33:12,865 [26] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:33:12,866 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:33:12,866 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:33:12,867 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:33:12,868 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:33:12,869 [26] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:33:12,870 [26] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:33:12,871 [26] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:33:12,871 [26] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:33:12,872 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:33:12,873 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:33:12,873 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:33:12,874 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:33:12,875 [26] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:33:12,875 [26] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:33:12,876 [26] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 17:33:12,877 [26] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 17:33:12,877 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 17:33:12,878 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 17:33:12,878 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 17:33:12,879 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 17:33:12,879 [26] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 17:33:12,880 [26] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 17:33:12,889 [26] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 17:33:12,899 [26] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'des';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 17:33:12,919 [26] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 17:33:12,921 [26] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:33:12,923 [26] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:33:12,925 [26] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 17:33:12,926 [26] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 17:33:12,942 [26] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 17:33:12,960 [26] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 17:33:12,976 [26] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 17:33:12,979 [26] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 17:33:12,983 [26] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 17:33:12,985 [26] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 17:33:12,987 [26] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:17:07,065 [7] INFO dn_lib.tools.log - reload core
2021-01-06 18:17:07,102 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:17:07,104 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:17:07,105 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:17:07,107 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:17:07,107 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:17:07,108 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:17:07,109 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:17:07,110 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:17:07,111 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:17:07,111 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:17:07,113 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:17:07,114 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:17:07,114 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:17:07,116 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:17:07,116 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:17:07,117 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:17:07,118 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:17:07,118 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:17:07,125 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:17:07,126 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:17:07,128 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:17:07,128 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:17:07,130 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:17:07,131 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:17:07,131 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:17:07,135 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:17:07,191 [7] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:17:07,198 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:17:07,200 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:17:07,202 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:17:07,207 [7] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(115, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:17:07,218 [7] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:17:07,232 [7] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(115, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:17:07,258 [7] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:17:07,272 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:17:07,354 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:17:07,357 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:17:07,359 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:18:23,091 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:23,092 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:23,094 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:23,094 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:23,095 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:23,096 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:23,097 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:23,098 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:23,099 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:23,100 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:23,100 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:23,101 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:23,101 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:23,102 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:23,103 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:23,103 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:23,104 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:23,105 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:23,105 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:23,106 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:23,106 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:23,107 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:23,108 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:23,108 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:23,109 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:23,109 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:23,153 [13] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 46
2021-01-06 18:18:23,156 [13] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 46
2021-01-06 18:18:31,098 [11] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:31,099 [11] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,100 [11] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,101 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,101 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,103 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,103 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,104 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,106 [11] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,107 [11] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,107 [11] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,107 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,108 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,109 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,110 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,110 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,111 [11] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,112 [11] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,112 [11] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,113 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,113 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,114 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,114 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,115 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,115 [11] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,116 [11] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:31,138 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:31,139 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,140 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,141 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,142 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,143 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,144 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,145 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,146 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,147 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,147 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,148 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,149 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,149 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,150 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,150 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,151 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,152 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,152 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,153 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,153 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,154 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,154 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,155 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,155 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,156 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:31,177 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:31,178 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,178 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,179 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,180 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,181 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,181 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,182 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,183 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,183 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,184 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,185 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,185 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,186 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,186 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,186 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,187 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,188 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:31,188 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:31,188 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:31,189 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:31,189 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:31,190 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:31,191 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:31,191 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:31,192 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:31,201 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:18:31,203 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:31,204 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:31,205 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:31,206 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:18:31,213 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:18:31,220 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:18:31,238 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:18:31,242 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:18:31,244 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:18:31,247 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:18:31,248 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:18:41,691 [5] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:41,692 [5] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,694 [5] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,695 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,695 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,696 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,697 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,697 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,698 [5] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,699 [5] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,699 [5] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,700 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,700 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,701 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,701 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,702 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,702 [5] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,703 [5] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,703 [5] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,704 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,704 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,705 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,706 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,707 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,707 [5] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,708 [5] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:41,723 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:41,724 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,725 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,725 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,726 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,727 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,728 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,728 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,729 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,730 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,730 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,730 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,731 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,731 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,732 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,732 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,733 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,733 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,734 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,734 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,735 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,735 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,736 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,736 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,737 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,737 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:41,750 [10] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:41,751 [10] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,752 [10] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,752 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,753 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,754 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,754 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,755 [10] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,756 [10] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,757 [10] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,757 [10] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,758 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,758 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,759 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,759 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,760 [10] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,760 [10] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,761 [10] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:41,761 [10] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:41,762 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:41,763 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:41,763 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:41,764 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:41,764 [10] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:41,765 [10] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:41,766 [10] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:41,775 [10] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'create table';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 18:18:41,807 [10] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:18:41,808 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:41,810 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:41,811 [10] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:41,812 [10] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:18:41,829 [10] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:18:41,848 [10] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 18:18:41,863 [10] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:18:41,865 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:18:41,866 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:18:41,867 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:18:41,868 [10] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:18:45,951 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:45,953 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:45,954 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:45,956 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:45,957 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:45,958 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:45,960 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:45,961 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:45,962 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:45,962 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:45,963 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:45,964 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:45,964 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:45,965 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:45,965 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:45,966 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:45,966 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:45,967 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:45,968 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:45,968 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:45,969 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:45,969 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:45,970 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:45,970 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:45,971 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:45,971 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:45,980 [8] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 46
2021-01-06 18:18:45,982 [8] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 46
2021-01-06 18:18:49,211 [11] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:49,212 [11] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,213 [11] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,214 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,215 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,216 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,216 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,217 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,218 [11] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,219 [11] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,219 [11] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,220 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,221 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,222 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,222 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,223 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,223 [11] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,224 [11] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,224 [11] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,225 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,225 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,226 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,226 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,227 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,227 [11] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,228 [11] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:49,243 [12] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:49,244 [12] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,244 [12] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,245 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,245 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,246 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,247 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,247 [12] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,248 [12] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,248 [12] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,249 [12] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,249 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,250 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,250 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,251 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,251 [12] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,252 [12] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,252 [12] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,253 [12] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,253 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,254 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,255 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,255 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,256 [12] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,256 [12] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,257 [12] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:49,268 [9] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:49,269 [9] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,270 [9] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,271 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,272 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,274 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,274 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,275 [9] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,276 [9] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,276 [9] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,277 [9] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,277 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,278 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,278 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,279 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,279 [9] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,280 [9] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,280 [9] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:49,281 [9] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:49,281 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:49,282 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:49,282 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:49,283 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:49,283 [9] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:49,284 [9] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:49,284 [9] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:49,294 [9] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:18:49,294 [9] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:49,295 [9] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:49,296 [9] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:18:49,297 [9] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:18:49,299 [9] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:18:49,301 [9] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:18:49,303 [9] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:18:49,307 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:18:49,309 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:18:49,310 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:18:49,311 [9] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:18:52,847 [5] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:18:52,849 [5] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:52,850 [5] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:52,852 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:52,853 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:52,854 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:52,855 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:52,856 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:52,856 [5] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:52,857 [5] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:52,858 [5] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:52,858 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:52,859 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:52,859 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:52,860 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:52,860 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:52,861 [5] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:52,861 [5] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:18:52,862 [5] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:18:52,862 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:18:52,863 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:18:52,863 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:18:52,864 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:18:52,864 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:18:52,865 [5] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:18:52,866 [5] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:18:52,875 [5] DEBUG dn_lib.tools.log - SQL: select content from dn_tasks_notes 
       where task_id = 45
2021-01-06 18:18:52,876 [5] DEBUG dn_lib.tools.log - SQL: select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = 45
2021-01-06 18:19:08,344 [11] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:08,345 [11] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,346 [11] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,348 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,348 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,349 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,350 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,350 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,351 [11] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,352 [11] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,353 [11] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,353 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,354 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,354 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,355 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,355 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,356 [11] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,356 [11] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,357 [11] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,357 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,358 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,358 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,359 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,359 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,360 [11] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,360 [11] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:08,382 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:08,383 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,384 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,385 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,386 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,387 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,389 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,389 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,390 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,391 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,391 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,392 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,392 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,393 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,394 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,394 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,395 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,395 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,396 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,396 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,397 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,397 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,398 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,399 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,399 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,400 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:08,412 [15] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:08,413 [15] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,414 [15] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,415 [15] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,416 [15] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,416 [15] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,417 [15] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,418 [15] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,419 [15] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,420 [15] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,420 [15] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,421 [15] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,422 [15] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,422 [15] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,423 [15] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,423 [15] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,424 [15] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,424 [15] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:08,425 [15] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:08,425 [15] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:08,426 [15] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:08,426 [15] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:08,427 [15] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:08,427 [15] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:08,428 [15] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:08,428 [15] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:08,438 [15] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'synch_machines';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 18:19:08,472 [15] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:08,475 [15] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:08,477 [15] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:08,478 [15] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:08,479 [15] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:08,496 [15] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:08,514 [15] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, null) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 18:19:08,530 [15] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:08,535 [15] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:08,538 [15] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:08,541 [15] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:08,543 [15] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:16,032 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:16,034 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,035 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,036 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,037 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,038 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,039 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,039 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,040 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,041 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,041 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,042 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,042 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,043 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,044 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,044 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,045 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,045 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,046 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,047 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,047 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,048 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,048 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,049 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,050 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,051 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:16,065 [11] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:16,066 [11] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,067 [11] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,068 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,069 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,070 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,071 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,071 [11] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,072 [11] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,072 [11] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,072 [11] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,073 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,073 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,074 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,074 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,074 [11] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,075 [11] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,075 [11] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:16,076 [11] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:16,076 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:16,077 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:16,077 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:16,078 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:16,078 [11] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:16,079 [11] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:16,080 [11] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:16,089 [11] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'synch_machines';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 18:19:16,090 [11] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:16,091 [11] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:16,092 [11] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:16,093 [11] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:16,094 [11] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:16,107 [11] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:16,127 [11] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 18:19:16,143 [11] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:16,145 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:16,145 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:16,146 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:16,147 [11] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:24,033 [7] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:24,034 [7] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:24,035 [7] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:24,037 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:24,038 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:24,038 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:24,039 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:24,040 [7] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:24,041 [7] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:24,042 [7] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:24,043 [7] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:24,044 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:24,045 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:24,046 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:24,046 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:24,047 [7] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:24,047 [7] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:24,048 [7] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:24,049 [7] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:24,051 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:24,052 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:24,053 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:24,054 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:24,054 [7] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:24,055 [7] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:24,056 [7] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:24,065 [7] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:24,067 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:24,069 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:24,070 [7] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:24,071 [7] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:24,077 [7] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:24,088 [7] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:19:24,104 [7] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:24,106 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:24,107 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:24,108 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:24,110 [7] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:34,945 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:34,947 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:34,948 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:34,950 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:34,951 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:34,953 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:34,954 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:34,955 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:34,955 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:34,956 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:34,957 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:34,957 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:34,958 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:34,959 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:34,959 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:34,960 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:34,960 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:34,961 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:34,961 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:34,962 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:34,962 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:34,963 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:34,964 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:34,964 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:34,965 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:34,965 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:34,976 [8] DEBUG dn_lib.tools.log - SQL: select sf.local_path + replace(dbo.folder_path(f.folder_id), '/', '\') as local_path, sf.synch_folder_id, f.folder_name as name
 from dn_folders f 
 join synch_folders sf on sf.synch_folder_id = f.synch_folder_id
 where f.folder_id = 114
2021-01-06 18:19:34,980 [8] DEBUG dn_lib.tools.log - SQL: select free_txt, stato, priorita, tipo, stima, (case when [default] = 1 then '1' else '0' end) as [default]
        from dn_task_free_labels 
2021-01-06 18:19:34,993 [8] DEBUG dn_lib.tools.log - SQL: insert into dn_folders (synch_folder_id, parent_id, folder_name, dt_ins, readed, dt_upd)
     select synch_folder_id, folder_id, '210106.orches.incorso.task', convert(datetime, convert(varchar, getdate(), 120), 120), 1, convert(datetime, convert(varchar, getdate(), 120), 120)
      from dn_folders where folder_id = 114;select SCOPE_IDENTITY();
2021-01-06 18:19:34,997 [8] DEBUG dn_lib.tools.log - SQL: insert into dn_tasks (synch_folder_id, folder_id, title, [user], stato, dt_upd, readed, priorita, tipo, stima, dt_ins)
 select synch_folder_id, folder_id, 'orches', NULL, 'in_corso', dt_upd, 1, NULL, NULL, NULL, dt_ins
  from dn_folders where folder_id = 120;select SCOPE_IDENTITY();
2021-01-06 18:19:35,007 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:35,008 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:35,009 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:35,011 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:35,011 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:35,012 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:35,013 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:35,014 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:35,015 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:35,015 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:35,016 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:35,017 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:35,017 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:35,018 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:35,018 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:35,019 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:35,019 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:35,020 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:35,020 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:35,021 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:35,021 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:35,022 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:35,023 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:35,023 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:35,024 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:35,024 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:35,033 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:35,034 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:35,035 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:35,036 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:35,037 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:35,038 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:35,039 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:19:35,041 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:35,044 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:35,045 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:35,046 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:35,047 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:40,803 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:40,804 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:40,805 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:40,806 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:40,806 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:40,807 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:40,808 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:40,809 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:40,809 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:40,810 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:40,810 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:40,811 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:40,812 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:40,812 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:40,814 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:40,814 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:40,816 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:40,816 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:40,816 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:40,817 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:40,818 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:40,818 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:40,819 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:40,819 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:40,820 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:40,820 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:40,830 [13] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'synch_machines';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 18:19:40,831 [13] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:40,832 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:40,833 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:40,833 [13] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:40,834 [13] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:40,835 [13] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:40,836 [13] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 18:19:40,838 [13] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:40,839 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:40,840 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:40,841 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:40,842 [13] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:41,371 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:41,371 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:41,372 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:41,373 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:41,373 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:41,374 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:41,375 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:41,375 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:41,376 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:41,377 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:41,377 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:41,378 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:41,378 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:41,379 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:41,380 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:41,381 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:41,382 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:41,382 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:41,383 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:41,383 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:41,384 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:41,384 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:41,385 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:41,386 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:41,386 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:41,387 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:41,396 [8] DEBUG dn_lib.tools.log - SQL: declare @txt varchar(max); set @txt = 'synch_machines';
declare @sid varchar(100); set @sid = 'qxxblvo1nkdkf1vginyawxd1';
declare @id int; 

select @id = search_id from dn_search_text where session_id = @sid and search_text = @txt;

if @id is null 
begin

 if not exists (select top 1 1 from dn_search_text where session_id = @sid)
 begin
  insert into dn_search_text (session_id, search_text)
   values (@sid, @txt);
   select @id = @@IDENTITY;  
 end
 else
 begin
  select @id = search_id from dn_search_text where session_id = @sid;
  update dn_search_text set search_text = @txt, dt_ins = getdate() where search_id = @id;
  delete from dn_search_tasks where search_id = @id; 
  delete from dn_search_folders where search_id = @id;
 end

 insert into dn_search_tasks (search_id, synch_folder_id, task_id, folder_id)
  select distinct @id as search_id, t2.synch_folder_id, t2.task_id, t2.folder_id
   from (select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks t where t.title like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_tasks_notes n
	 join dn_tasks t on t.task_id = n.task_id
	 where n.content like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files f
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where f.file_name like '%' + @txt + '%'
	union select t.task_id, t.synch_folder_id, t.folder_id 
	 from dn_files_contents fc 
	 join dn_files f on f.file_id = fc.file_id
	 join dn_tasks t on t.folder_id = f.folder_id or t.file_id = f.file_id
	 where fc.content like '%' + @txt + '%') t2

 insert into dn_search_folders (search_id, synch_folder_id, folder_id)
  select @id as search_id, sf.synch_folder_id, null as folder_id
   from synch_folders sf
   join (select distinct synch_folder_id from dn_search_tasks) t on t.synch_folder_id = sf.synch_folder_id
  union select @id as search_id, fp.synch_folder_id, fp.folder_id
   from (select distinct folder_id from dn_search_tasks) t
  cross apply [dbo].[folder_parents](t.folder_id) fp; 

 delete t from dn_search_tasks t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete t from dn_search_folders t
  join dn_search_text s on t.search_id = s.search_id and datediff(hour, s.dt_ins, getdate()) > 5;
 
 delete from dn_search_text where datediff(hour, dt_ins, getdate()) > 5;

end

select @id as search_id, count(*) as cc from dn_search_tasks where search_id = @id;


2021-01-06 18:19:41,398 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:41,399 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:41,400 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:41,400 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:41,401 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:41,402 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        join dn_search_folders sf on sf.search_id = 4 
          and sf.synch_folder_id = ft.synch_folder_id and isnull(sf.folder_id, 0) = isnull(ft.folder_id, 0)
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:41,404 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    join dn_search_tasks st on st.search_id = 4 and st.task_id = t.task_id
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 
2021-01-06 18:19:41,405 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:41,407 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:41,408 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:41,409 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:41,410 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:44,386 [5] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:44,388 [5] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:44,389 [5] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:44,390 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:44,391 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:44,392 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:44,393 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:44,393 [5] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:44,394 [5] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:44,395 [5] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:44,396 [5] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:44,397 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:44,397 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:44,398 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:44,399 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:44,400 [5] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:44,401 [5] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:44,401 [5] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:44,402 [5] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:44,402 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:44,403 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:44,403 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:44,404 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:44,404 [5] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:44,405 [5] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:44,405 [5] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:44,415 [5] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:44,416 [5] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:44,417 [5] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:44,418 [5] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:44,418 [5] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(114, null) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:44,420 [5] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:44,421 [5] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(114, null) ft 
	    where  ft.tp <> 'synch_folder' and  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:19:44,422 [5] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:44,425 [5] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:44,426 [5] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:44,426 [5] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:44,427 [5] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
2021-01-06 18:19:50,035 [13] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:50,036 [13] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,037 [13] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,038 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,039 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,039 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,040 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,041 [13] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,041 [13] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,042 [13] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,042 [13] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,043 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,043 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,044 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,045 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,046 [13] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,047 [13] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,048 [13] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,048 [13] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,049 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,049 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,050 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,050 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,051 [13] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,051 [13] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,052 [13] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:50,064 [8] INFO dn_lib.tools.log - reload config docs
2021-01-06 18:19:50,065 [8] INFO dn_lib.tools.log - load xml config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,065 [8] INFO dn_lib.tools.log - load xml config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,066 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,067 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,067 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,068 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,069 [8] INFO dn_lib.tools.log - load xml config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,069 [8] INFO dn_lib.tools.log - load xml config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,070 [8] INFO dn_lib.tools.log - load vars doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,070 [8] INFO dn_lib.tools.log - load vars doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,071 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,071 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,072 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,072 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,073 [8] INFO dn_lib.tools.log - load vars doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,073 [8] INFO dn_lib.tools.log - load vars doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,073 [8] INFO dn_lib.tools.log - load config doc: \defs\blocks.xml - C:\root\todd\git\dn\deepanotes\defs\blocks.xml
2021-01-06 18:19:50,074 [8] INFO dn_lib.tools.log - load config doc: \defs\cmds.xml - C:\root\todd\git\dn\deepanotes\defs\cmds.xml
2021-01-06 18:19:50,074 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-base.xml - C:\root\todd\git\dn\deepanotes\defs\lib-base.xml
2021-01-06 18:19:50,075 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-conns.xml - C:\root\todd\git\dn\deepanotes\defs\lib-conns.xml
2021-01-06 18:19:50,075 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-notes.xml - C:\root\todd\git\dn\deepanotes\defs\lib-notes.xml
2021-01-06 18:19:50,076 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-synch.xml - C:\root\todd\git\dn\deepanotes\defs\lib-synch.xml
2021-01-06 18:19:50,076 [8] INFO dn_lib.tools.log - load config doc: \defs\lib-vars.xml - C:\root\todd\git\dn\deepanotes\defs\lib-vars.xml
2021-01-06 18:19:50,077 [8] INFO dn_lib.tools.log - load config doc: \defs\users.xml - C:\root\todd\git\dn\deepanotes\defs\users.xml
2021-01-06 18:19:50,078 [8] DEBUG dn_lib.tools.log - SQL: open conn 'Data Source=localhost;Initial Catalog=deepanotes;User ID=sa;Password=Molina32!'
2021-01-06 18:19:50,088 [8] DEBUG dn_lib.tools.log - SQL: select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order
2021-01-06 18:19:50,089 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:50,090 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:50,091 [8] DEBUG dn_lib.tools.log - SQL: select var_name, var_value 
          from users_cache where [user_id] = 0 and var_name in ('active-task-filter')
2021-01-06 18:19:50,091 [8] DEBUG dn_lib.tools.log - SQL: select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders(null, 1) ft
      
      order by ft.synch_folder_id, ft.lvl, ft.title
2021-01-06 18:19:50,099 [8] DEBUG dn_lib.tools.log - SQL: select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders(null, 1) ft 
        
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))
2021-01-06 18:19:50,117 [8] DEBUG dn_lib.tools.log - SQL: select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
    
	  left join dn_files f on f.file_id = t.file_id
    where (null is null or (null is not null and t.task_id = null)) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders(null, 1) ft 
	    where  ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1  and t3.stato = 'in_corso' or t3.diff_days = 1
2021-01-06 18:19:50,137 [8] DEBUG dn_lib.tools.log - SQL: select title_singolare, stato from dn_task_stato order by [order]
2021-01-06 18:19:50,141 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]
2021-01-06 18:19:50,142 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]
2021-01-06 18:19:50,143 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]
2021-01-06 18:19:50,145 [8] DEBUG dn_lib.tools.log - SQL: select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2
